<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport"content="width=device-width,initial-scale=1"/>
<title>Bank Account</title>
<style>
  :root{
    --main:#ffffff;           /* 60% */
    --secondary: rgba(30,136,229,0.35); /* 30% liquid glass blue buttons */
    --accent:#f5f0e1;         /* 10% beige */
    --text:#111;
    --glass-black: rgba(0,0,0,0.36);
    --glass-hover: rgba(0,0,0,0.5);
  }
  html,body{height:100%;margin:0;font-family:Inter,Poppins;background:var(--accent);color:var(--text)}
  .wrap{max-width:1200px;margin:28px auto;padding:18px}
  .panel{background:var(--main);border-radius:14px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.06);margin-bottom:18px}
  .top{display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:1.5rem}
  .glass-btn{background:var(--glass-black);color:var(--main);padding:10px 16px;border-radius:12px;border:none;font-weight:700;cursor:pointer;backdrop-filter: blur(8px)}
  .glass-btn:hover{background:var(--glass-hover)}
  .columns{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:14px}
  .stat{padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef3f8}
  .stat h3{margin:0;font-size:1rem}
  .muted{color:#58616a;font-size:0.95rem}
  .small{font-size:0.9rem;color:#667085}
  .ads-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .ad-card{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:#fff;border:1px solid #efefef}
  .ad-card img{width:64px;height:64px;border-radius:8px;object-fit:cover}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  input,select{padding:8px;border-radius:8px;border:1px solid #e6e9ee}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid #eef2f6;padding:8px;text-align:left}
  .admin-block{background:#f8fafb;padding:12px;border-radius:10px}
  #stockChart{width:100%;height:180px;background:linear-gradient(180deg,#fff,#f6fbff);border-radius:10px;padding:12px}
  @media (max-width:960px){ .columns{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>Bank Account</h1>
    <div>
      <button class="glass-btn" id="toMarket">Go to Marketplace</button>
      <button class="glass-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="panel" id="accountPanel">
    <div id="welcomeLine"></div>
    <div class="columns" style="margin-top:12px">
      <div>
        <div class="stat">
          <h3>Balance</h3>
          <div style="font-size:22px;font-weight:800">₱<span id="balanceVal">0</span></div>
          <div class="small">Weekly salary controlled by admins. Wages add at 6:00 AM daily (calculated on sign-in).</div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1">
            <div class="stat">
              <h3>Gift credits</h3>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="giftTo" placeholder="Recipient first name" />
                <input id="giftAmt" type="number" placeholder="₱ amount" style="width:120px" />
                <button class="glass-btn" id="giftBtn">Send</button>
              </div>
            </div>
          </div>
          <div style="width:220px">
            <div class="stat">
              <h3>Loans</h3>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="loanAmt" type="number" placeholder="Amount" />
                <button class="glass-btn" id="loanBtn">Take Loan</button>
              </div>
              <div class="small" style="margin-top:8px">Loans increase your balance immediately and are tracked. Admins can manage loans.</div>
            </div>
          </div>
        </div>

        <div style="margin-top:14px" class="stat">
          <h3>Transaction History</h3>
          <div id="txList" style="max-height:160px;overflow:auto"></div>
        </div>

        <div style="margin-top:14px" class="stat">
          <h3>Stock Market (fun)</h3>
          <div id="stockChart"><canvas id="stockCanvas" width="800" height="160"></canvas></div>
          <div class="small" style="margin-top:8px">Randomized bars — just for fun. Refresh simulates a new day.</div>
          <div style="margin-top:6px">
            <button class="glass-btn" id="refreshStock">New day</button>
          </div>
        </div>
      </div>

      <aside>
        <div class="panel" style="padding:12px;background:#fff;border:1px solid #efefef">
          <h3 style="margin-top:0">Marketplace Ads</h3>
          <div id="ads" class="ads-grid"></div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3 style="margin-top:0">Wage Settings</h3>
          <div class="small">Current daily wage: ₱<span id="dailyWageVal">50</span></div>
          <div style="margin-top:8px" id="adminWageControls" class="admin-block" hidden>
            <label>Set daily wage: <input id="setWage" type="number" /></label>
            <button class="glass-btn" id="saveWage">Save</button>
            <div class="small" style="margin-top:8px">Admins only: change the wage amount (default 50/day).</div>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <h3 style="margin-top:0">Admin Tools</h3>
          <div id="adminPanel" hidden>
            <div class="small">Adjust credits for classmates:</div>
            <div id="adminUserList" style="margin-top:8px"></div>
            <div style="margin-top:10px">
              <button class="glass-btn" id="viewAllListings">View All Listings</button>
              <button class="glass-btn" id="exportData" title="Export data as JSON">Export Data</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="small" style="text-align:center;color:#6b7280">Need help? Contact Alfred or Lexie (admins) — they can edit wages and manage listings.</div>
</div>

<script>
/* bank.html logic — unified data model lives in localStorage key 'ccs_data' */
(function(){
  // helper: load/save
  function load(){ return JSON.parse(localStorage.getItem('ccs_data')||'null'); }
  function save(d){ localStorage.setItem('ccs_data', JSON.stringify(d)); }

  // initialize base data if missing
  function init(){
    if(localStorage.getItem('ccs_data')) return;
    const classmates = ["Sophia","Alex","William","Pablo","Leon","Lexie","Alfred","Chloe","Ariel","Miya","Noah"];
    const users = classmates.map(n=>({ name:n, credits:100, isAdmin: (n==='Alfred'||n==='Lexie'), lastWageClaim: null }));
    const data = {
      users,
      listings: [], // { id, title, desc, price, seller, delivery, image, createdAt }
      bids: [],     // { id, productId, user, amount, at }
      settings: { dailyWage:50 },
      loans: [],    // { id, user, amount, at }
      stock:{ history: generateStock() }
    };
    save(data);
  }

  // stock generator (7 bars)
  function generateStock(){
    const arr=[];
    for(let i=0;i<7;i++){
      const base = 50 + Math.round(Math.random()*50); // base value
      const delta = Math.round((Math.random()-0.5)*20);
      arr.push(Math.max(10, base + delta));
    }
    return arr;
  }

  init();
  let data = load();

  // session
  const session = JSON.parse(localStorage.getItem('ccs_session') || 'null');
  if(!session){ alert('No active session. Redirecting to sign-in.'); window.location.href='signin.html'; }

  // UI elements
  const welcomeLine = document.getElementById('welcomeLine');
  const balanceEl = document.getElementById('balanceVal');
  const txList = document.getElementById('txList');
  const adsEl = document.getElementById('ads');
  const dailyWageVal = document.getElementById('dailyWageVal');
  const adminPanel = document.getElementById('adminPanel');
  const adminWageControls = document.getElementById('adminWageControls');
  const adminUserList = document.getElementById('adminUserList');
  const setWage = document.getElementById('setWage');

  // navigation buttons
  document.getElementById('toMarket').addEventListener('click', ()=> window.location.href='marketplace.html');
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('ccs_session');
    window.location.href='signin.html';
  });

  // show basic info and set up admin UI if needed
  function renderAccount(){
    data = load();
    const me = data.users.find(u=>u.name===session.name);
    welcomeLine.innerHTML = `<strong>Hi, ${session.name}.</strong> Last login: ${new Date().toLocaleString()}`;
    balanceEl.textContent = (me?.credits||0).toFixed(2);
    dailyWageVal.textContent = data.settings.dailyWage;

    // show ads (random 3 listings or message)
    renderAds();

    // render txs (we'll treat loans array + bid events as simple transaction log)
    const txs = [...(data.loans || [])].reverse().slice(0,50);
    txList.innerHTML = txs.length ? txs.map(t=>`<div style="padding:8px;border-bottom:1px solid #eef2f6"><strong>${t.user||t.name||t.type}</strong> • ${t.type||t.amount||t.note||''} ${t.amount?('₱'+t.amount):''} <div class="small">${t.at||t.date||''}</div></div>`).join('') : '<div class="small">No transactions yet.</div>';

    // admin features
    if(session.isAdmin){
      adminPanel.hidden = false;
      adminWageControls.hidden = false;
      renderAdminUserList();
      setWage.value = data.settings.dailyWage;
    } else {
      adminPanel.hidden = true;
      adminWageControls.hidden = true;
    }
  }

  function renderAds(){
    adsEl.innerHTML = '';
    if(data.listings.length === 0){
      adsEl.innerHTML = `<div class="small">No marketplace items yet.</div>`;
      return;
    }
    // pick up to 3 random
    const shuffled = [...data.listings].sort(()=>Math.random()-0.5).slice(0,3);
    shuffled.forEach(l=>{
      const div = document.createElement('div'); div.className='ad-card';
      div.innerHTML = `<img src="${l.image||'https://via.placeholder.com/128'}" alt=""><div><strong>${l.title}</strong><div class="muted">Seller: ${l.seller}</div><div style="margin-top:6px"><button class="glass-btn" onclick="location.href='marketplace.html#product_${l.id}'">View</button></div></div>`;
      adsEl.appendChild(div);
    });
  }

  // gift credits
  document.getElementById('giftBtn').addEventListener('click', ()=>{
    const to = (document.getElementById('giftTo').value || '').trim();
    const amt = parseFloat(document.getElementById('giftAmt').value);
    if(!to || !amt || amt<=0) return alert('Enter recipient and valid amount.');
    const user = data.users.find(u=>u.name.toLowerCase()===to.toLowerCase());
    const me = data.users.find(u=>u.name===session.name);
    if(!user) return alert('Recipient not found.');
    if(me.credits < amt) return alert('Insufficient credits.');
    me.credits -= amt; user.credits += amt;
    // log
    data.loans.push({ type:'gift', user:me.name, to:user.name, amount:amt, at:new Date().toISOString() });
    save(data);
    renderAccount();
    alert(`Sent ₱${amt} to ${user.name}`);
  });

  // take loan
  document.getElementById('loanBtn').addEventListener('click', ()=>{
    const amt = parseFloat(document.getElementById('loanAmt').value);
    if(!amt || amt<=0) return alert('Enter loan amount.');
    const me = data.users.find(u=>u.name===session.name);
    me.credits += amt;
    data.loans.push({ type:'loan', user:me.name, amount:amt, at:new Date().toISOString() });
    save(data);
    renderAccount();
    alert(`Loan granted: ₱${amt}.`);
  });

  // stock chart generation
  const ctx = document.getElementById('stockCanvas').getContext('2d');
  function drawStock(){
    const arr = data.stock.history;
    const w = ctx.canvas.width = ctx.canvas.clientWidth;
    const h = ctx.canvas.height = 160;
    ctx.clearRect(0,0,w,h);
    const max = Math.max(...arr,50);
    const gap = 12;
    const barW = (w - gap*(arr.length+1)) / arr.length;
    arr.forEach((v,i)=>{
      const x = gap + i*(barW+gap);
      const barH = (v/max) * (h - 20);
      ctx.fillStyle = v >= 50 ? '#16a34a' : '#ef4444'; // green if above baseline
      ctx.fillRect(x, h - barH - 10, barW, barH);
      ctx.fillStyle = '#334155';
      ctx.font = '12px Inter, Poppins';
      ctx.fillText(v, x+6, h - barH - 14);
    });
  }
  document.getElementById('refreshStock').addEventListener('click', ()=>{
    data.stock.history = generateStock();
    save(data); drawStock();
  });

  // admin wage controls
  document.getElementById('saveWage').addEventListener('click', ()=>{
    const val = parseInt(setWage.value);
    if(isNaN(val) || val<0) return alert('Enter valid wage');
    data.settings.dailyWage = val; save(data); renderAccount();
    alert(`Daily wage set to ₱${val}`);
  });

  // admin user list
  function renderAdminUserList(){
    adminUserList.innerHTML = '';
    data.users.forEach(u=>{
      const div = document.createElement('div');
      div.style.display='flex'; div.style.alignItems='center'; div.style.gap='8px'; div.style.marginBottom='8px';
      div.innerHTML = `<div style="flex:1">${u.name} — ₱${u.credits.toFixed(2)} ${u.isAdmin?'<strong>(admin)</strong>':''}</div>`;
      const add = document.createElement('button'); add.className='glass-btn'; add.textContent='+10'; add.onclick=()=>{u.credits+=10; save(data); renderAccount();};
      const sub = document.createElement('button'); sub.className='glass-btn'; sub.textContent='-10'; sub.onclick=()=>{u.credits-=10; save(data); renderAccount();};
      div.appendChild(add); div.appendChild(sub);
      adminUserList.appendChild(div);
    });
  }

  // export data
  document.getElementById('exportData').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='ccs_data_export.json'; a.click();
    URL.revokeObjectURL(url);
  });

  // view all listings
  document.getElementById('viewAllListings').addEventListener('click', ()=>{
    let html = data.listings.length ? data.listings.map(l=>`<div style="padding:8px;border-bottom:1px solid #eef2f6"><strong>${l.title}</strong> — Seller: ${l.seller} — ₱${l.price}</div>`).join('') : '<div>No listings</div>';
    const w = window.open('','Listings','width=600,height=600'); w.document.body.innerHTML = `<pre style="font-family:Inter;padding:12px">${html}</pre>`;
  });

  // initial render
  renderAccount();
  drawStock();

  // show admin block only for admins
  if(session.isAdmin) adminPanel.hidden = false;

})();
</script>
</body>
</html>
